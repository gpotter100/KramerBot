<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KramerBot – Weekly NFL Usage</title>

  <link rel="icon" type="image/png" href="assets/KramerBot_Icon.png">

  <link rel="stylesheet" href="/styles/layout.css" />
  <link rel="stylesheet" href="/styles/sidebar.css" />
  <link rel="stylesheet" href="/styles/nfl.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>

<body>
  <div id="app">

    <!-- SIDEBAR -->
    <aside id="sidebar">
      <div class="sidebar-logo">
        <span class="logo-main">KramerBot</span>
        <span class="logo-sub">“I got stats… probably.”</span>
      </div>

      <nav class="sidebar-nav">
        <button class="nav-btn" onclick="window.location.href='index.html'">Home</button>
        <button class="nav-btn" onclick="window.location.href='upload.html'">Upload CSV</button>
        <button class="nav-btn" onclick="window.location.href='standings.html'">Standings</button>
        <button class="nav-btn" onclick="window.location.href='stats.html'">Basic Stats</button>
        <button class="nav-btn" onclick="window.location.href='visuals.html'">Visuals</button>

        <!-- NFL DROPDOWN -->
        <div class="sidebar-dropdown">
          <button class="nav-btn dropdown-toggle">
            NFL Statistics ▾
          </button>

          <div class="dropdown-menu">
            <button class="nav-sub-btn" onclick="window.location.href='nfl_usage.html'">
              Weekly Usage
            </button>
            <button class="nav-sub-btn" onclick="window.location.href='nfl_multi_usage.html'">
              Multi‑Week Usage
            </button>
            <button class="nav-sub-btn" onclick="window.location.href='nfl_multi_pbp.html'">
              PBP Explorer
            </button>
          </div>
        </div>

        <button class="nav-btn" data-page="about">About</button>
      </nav>

      <div class="sidebar-icon-container">
        <img src="assets/KramerBot_Icon.png" id="sidebar-kramer-icon" alt="KramerBot Icon" />
      </div>

      <div class="sidebar-footer">
        <span>KramerBot © 2026</span>
        <span class="disclaimer">No guarantees. At all.</span>
      </div>
    </aside>

    <!-- MOBILE HAMBURGER -->
    <div id="hamburger-menu">
      <button id="hamburger-toggle">&#9776;</button>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main">
      <main class="content">

        <!-- WEEKLY FILTER BAR -->
        <section class="filter-bar card">
          <div class="filter-group">
            <label for="season-input">Season</label>
            <select id="season-input"></select>
          </div>

          <div class="filter-group">
            <label for="week-input">Week</label>
            <select id="week-input"></select>
          </div>

          <div class="filter-group">
            <label for="position-filter">Position</label>
            <select id="position-filter">
              <option value="ALL">All</option>
              <option value="QB">QB</option>
              <option value="RB">RB</option>
              <option value="WR">WR</option>
              <option value="TE">TE</option>
              <option value="WR/TE">WR/TE</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="scoring-filter">Scoring</label>
            <select id="scoring-filter">
              <option value="standard">Standard</option>
              <option value="ppr">PPR</option>
              <option value="half-ppr">Half-PPR</option>
              <option value="vandalay">Vandalay</option>
              <option value="shen2000">SHEN 2000</option>
            </select>
          </div>

          <button id="load-btn" class="primary-btn">Load Stats</button>
        </section>

        <div id="loading-indicator" class="loading hidden">Loading…</div>

        <!-- TOP PERFORMERS -->
        <section id="top-performers" class="card hidden">
          <h2>Top Performers</h2>
          <ul id="top-list" class="top-list"></ul>
        </section>

        <!-- WEEKLY USAGE TABLE -->
        <section id="table-wrapper" class="table-wrapper hidden">
          <table id="usage-table" class="data-table">
            <thead>
              <tr>
                <th>Pos</th>
                <th>Player</th>
                <th>Team</th>

                <!-- PASSING -->
                <th colspan="9" class="group">Passing</th>
                <!-- RUSHING -->
                <th colspan="4" class="group">Rushing</th>

                <!-- RECEIVING -->
                <th colspan="4" class="group">Receiving</th>
                <!-- TURNOVERS -->
                <th colspan="4" class="group">Turnovers</th>

                <!-- FANTASY -->
                <th colspan="4" class="group">Fantasy</th>
              </tr>

              <tr>
                <!-- Identity -->
                <th data-sort="position">Pos</th>
                <th data-sort="player_name">Player</th>
                <th data-sort="team">Team</th>

                <!-- PASSING -->
                <th data-sort="passing_yards">Yds</th>
                <th data-sort="comp_passing_yards">FPTS (Yds)</th>
                <th data-sort="pct_passing_yards">% Yds</th>

                <th data-sort="passing_tds">TD</th>
                <th data-sort="comp_passing_tds">FPTS (TD)</th>
                <th data-sort="pct_passing_tds">% TD</th>

                <th data-sort="interceptions">INT</th>
                <th data-sort="comp_interceptions">FPTS (INT)</th>
                <th data-sort="pct_interceptions">% INT</th>

                <!-- RUSHING -->
                <th data-sort="rushing_yards">Yds</th>
                <th data-sort="comp_rushing_yards">FPTS (Yds)</th>
                <th data-sort="pct_rushing_yards">% Yds</th>
                <th data-sort="rushing_tds">TD</th>
                <th data-sort="comp_rushing_tds">FPTS (TD)</th>
                <th data-sort="pct_rushing_tds">% TD</th>
                <!-- RECEIVING -->
                <th data-sort="receptions">Rec</th>
                <th data-sort="comp_receptions">FPTS (Rec)</th>
                <th data-sort="pct_receptions">% Rec</th>
                <th data-sort="receiving_yards">Yds</th>
                <th data-sort="comp_receiving_yards">FPTS (Yds)</th>
                <th data-sort="pct_receiving_yards">% Yds</th>
                <th data-sort="receiving_tds">TD</th>
                <th data-sort="comp_receiving_tds">FPTS (TD)</th>
                <th data-sort="pct_receiving_tds">% TD</th>

                <!-- TURNOVERS -->
                <th data-sort="fumbles_lost">Fum Lost</th>
                <th data-sort="comp_fumbles_lost">FPTS (Fum)</th>
                <th data-sort="pct_fumbles_lost">% Fum</th>

                <th data-sort="sack_fumbles">Sack Fum</th>
                <th data-sort="comp_sack_fumbles">FPTS (Sack Fum)</th>
                <th data-sort="pct_sack_fumbles">% Sack Fum</th>
                <!-- FANTASY TOTALS -->
                <th data-sort="fantasy_points_vandalay">Vandalay</th>
                <th data-sort="fantasy_points_ppr">PPR</th>
                <th data-sort="fantasy_points_half">Half</th>
                <th data-sort="fantasy_points_shen2000">Shen2000</th>
              </tr>
            </thead>

            <tbody id="usage-body"></tbody>
          </table>
        </section>

        <!-- WEEKLY PBP PANEL -->
        <section id="pbp-panel" class="card hidden">
          <h2>Play-by-play</h2>

          <div class="filter-bar" style="margin-bottom: 12px;">
            <div class="filter-group">
              <label for="pbp-season-type">Season type</label>
              <select id="pbp-season-type">
                <option value="REG" selected>REG</option>
                <option value="POST">POST</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="pbp-games-select">Game</label>
              <select id="pbp-games-select"></select>
            </div>

            <button id="pbp-load-btn" class="primary-btn" type="button">Load PBP</button>
          </div>

          <div id="pbp-loading" class="loading hidden">Loading play-by-play…</div>

          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Q</th>
                  <th>Down</th>
                  <th>To go</th>
                  <th>Ydline</th>
                  <th>Off</th>
                  <th>Type</th>
                  <th>Yds</th>
                  <th>EPA</th>
                  <th>WP</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="pbp-body"></tbody>
            </table>
          </div>
        </section>

        <!-- WEEKLY CHARTS -->
        <section id="charts-container" class="charts-grid hidden">
          <div class="chart-card card">
            <h2>Touches & Snap %</h2>
            <canvas id="touches-chart"></canvas>
            <canvas id="snap-chart" style="margin-top:16px;"></canvas>
          </div>

          <div class="chart-card card">
            <h2>Usage Breakdown</h2>
            <canvas id="usage-donut"></canvas>
          </div>
        </section>

        <!-- PLAYER COMPARISON -->
        <section id="compare-panel" class="card hidden">
          <h2>Compare Players</h2>
          <select id="compare-select"></select>
          <div id="compare-metrics" class="compare-metrics"></div>
        </section>

      </main>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script type="module" src="scripts/config.js" defer></script>
  <script type="module" src="scripts/nfl.js" defer></script>
  <script type="module" src="scripts/main.js" defer></script>

<script type="module">
  import { API_BASE as BACKEND_URL } from './scripts/config.js';

  function num(v) {
    return typeof v === "number" ? v : 0;
  }

  function getFantasyField(scoring) {
    switch (scoring) {
      case "ppr": return "fantasy_points_ppr";
      case "half-ppr": return "fantasy_points_half";
      case "vandalay": return "fantasy_points_vandalay";
      case "shen2000": return "fantasy_points_shen2000";
      default: return "fantasy_points";
    }
  }

  const TEAM_COLORS = {
    ARI: "#97233F",
    ATL: "#A71930",
    BAL: "#241773",
    BUF: "#00338D",
    CAR: "#0085CA",
    CHI: "#0B162A",
    CIN: "#FB4F14",
    CLE: "#311D00",
    DAL: "#003594",
    DEN: "#FB4F14",
    DET: "#0076B6",
    GB: "#203731",
    HOU: "#03202F",
    IND: "#002C5F",
    JAX: "#006778",
    KC: "#E31837",
    LAC: "#0080C6",
    LAR: "#003594",
    LV: "#000000",
    MIA: "#008E97",
    MIN: "#4F2683",
    NE: "#002244",
    NO: "#D3BC8D",
    NYG: "#0B2265",
    NYJ: "#125740",
    PHI: "#004C54",
    PIT: "#FFB612",
    SEA: "#002244",
    SF: "#AA0000",
    TB: "#D50A0A",
    TEN: "#4B92DB",
    WAS: "#5A1414"
  };

  let currentRows = [];
  let currentSort = { field: null, asc: true };

  function renderRows(rows) {
    const usageBody = document.getElementById("usage-body");

    usageBody.innerHTML = rows.map(row => `
      <tr data-player-id="${row.player_id || row.playerId || row.gsis_id || row.id}">
        <td>${row.position ?? ""}</td>
        <td>${row.player_name ?? ""}</td>
        <td style="color:${TEAM_COLORS[row.team] || '#ccc'}; font-weight:600;">
          ${row.team ?? ""}
        </td>


        <!-- PASSING -->
      <td>${fmt(row.passing_yards)}</td>
      <td>${fmt(row.comp_passing_yards)}</td>
      <td>${pct(row.pct_passing_yards)}</td>

      <td>${fmt(row.passing_tds)}</td>
      <td>${fmt(row.comp_passing_tds)}</td>
      <td>${pct(row.pct_passing_tds)}</td>

      <td>${fmt(row.interceptions)}</td>
      <td>${fmt(row.comp_interceptions)}</td>
      <td>${pct(row.pct_interceptions)}</td>

      <!-- RUSHING -->
      <td>${fmt(row.rushing_yards)}</td>
      <td>${fmt(row.comp_rushing_yards)}</td>
      <td>${pct(row.pct_rushing_yards)}</td>

      <td>${fmt(row.rushing_tds)}</td>
      <td>${fmt(row.comp_rushing_tds)}</td>
      <td>${pct(row.pct_rushing_tds)}</td>

      <!-- RECEIVING -->
      <td>${fmt(row.receptions)}</td>
      <td>${fmt(row.comp_receptions)}</td>
      <td>${pct(row.pct_receptions)}</td>

      <td>${fmt(row.receiving_yards)}</td>
      <td>${fmt(row.comp_receiving_yards)}</td>
      <td>${pct(row.pct_receiving_yards)}</td>

      <td>${fmt(row.receiving_tds)}</td>
      <td>${fmt(row.comp_receiving_tds)}</td>
      <td>${pct(row.pct_receiving_tds)}</td>

      <!-- TURNOVERS -->
      <td>${fmt(row.fumbles_lost)}</td>
      <td>${fmt(row.comp_fumbles_lost)}</td>
      <td>${pct(row.pct_fumbles_lost)}</td>

      <td>${fmt(row.sack_fumbles)}</td>
      <td>${fmt(row.comp_sack_fumbles)}</td>
      <td>${pct(row.pct_sack_fumbles)}</td>

      <!-- FANTASY TOTALS -->
      <td>${fmt(row.fantasy_points_vandalay)}</td>
      <td>${fmt(row.fantasy_points_ppr)}</td>
      <td>${fmt(row.fantasy_points_half)}</td>
      <td>${fmt(row.fantasy_points_shen2000)}</td>
    </tr>
  `).join("");

  usageBody.querySelectorAll("tr").forEach(tr => {
    tr.addEventListener("click", () => {
      const playerId = tr.dataset.playerId;
      selectPlayer(playerId);
    });
  });
}

function fmt(v) {
  return (v === undefined || v === null) ? "" : Number(v).toFixed(2);
}

function pct(v) {
  return (v === undefined || v === null) ? "" : (Number(v) * 100).toFixed(1) + "%";
}


  function selectPlayer(playerId) {
    const player = currentRows.find(
      p => p.player_id == playerId ||
           p.playerId == playerId ||
           p.gsis_id == playerId ||
           p.id == playerId
    );

    if (!player) {
      console.warn("Player not found for click:", playerId);
      return;
    }

    document.getElementById("charts-container").classList.remove("hidden");
    renderAttributionChart(player);
  }

  window.selectPlayer = selectPlayer;


  function getAttributionData(player) {
    return {
      labels: [
        "Pass Yds",
        "Pass TD",
        "Rush Yds",
        "Rush TD",
        "Rec Yds",
        "Rec TD",
        "Fumbles"
      ],
      values: [
        player.comp_passing_yards,
        player.comp_passing_tds,
        player.comp_rushing_yards,
        player.comp_rushing_tds,
        player.comp_receiving_yards,
        player.comp_receiving_tds,
        player.comp_fumbles_lost
      ]
    };
  }

  let attributionChart = null;

  function renderAttributionChart(data) {
    const canvas = document.getElementById("usage-donut");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");

    // Destroy previous chart if it exists
    if (attributionChart) {
      attributionChart.destroy();
      attributionChart = null;
    }

    const labels = ["Passing", "Rushing", "Receiving", "Fumbles"];
    const values = [
      num(data.comp_passing_yards) + num(data.comp_passing_tds),
      num(data.comp_rushing_yards) + num(data.comp_rushing_tds),
      num(data.comp_receiving_yards) + num(data.comp_receiving_tds),
      num(data.comp_fumbles_lost)
    ];
    attributionChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: ["#4e79a7", "#59a14f", "#f28e2b", "#e15759"]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.label}: ${fmt1(ctx.raw)} pts`        
            }
          }
        }
      }
    });
  }


  function enableSorting() {
    document.querySelectorAll("#usage-table thead th").forEach(th => {
      th.onclick = () => {
        const field = th.dataset.sort;
        if (!field) return;

        if (currentSort.field === field) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort.field = field;
          currentSort.asc = true;
        }

        currentRows.sort((a, b) => {
          const va = a[field] ?? 0;
          const vb = b[field] ?? 0;

          if (typeof va === "string") {
            return currentSort.asc
              ? va.localeCompare(vb)
              : vb.localeCompare(va);
          }

          return currentSort.asc ? va - vb : vb - va;
        });

        renderRows(currentRows);
      };
    });
  }

  function renderTopPerformers(rows) {
    const top = [...rows]
      .sort((a, b) => b.fantasy_points_active - a.fantasy_points_active)
      .slice(0, 10);

    const list = document.getElementById("top-list");

    list.innerHTML = top.map(p => `
      <li data-player-id="${p.player_id}">
        <strong>${p.player_name}</strong>
        <span>(${p.team} - ${p.position})</span>
        <span>${fmt(p.fantasy_points_active)} pts</span>
      </li>
    `).join("");

    document.getElementById("top-performers").classList.remove("hidden");
  }


  async function initDropdowns() {
    const seasonInput = document.getElementById("season-input");
    const weekInput = document.getElementById("week-input");

    const res = await fetch(`${BACKEND_URL}/nfl/seasons`);
    const seasons = await res.json();

    seasonInput.innerHTML = seasons.map(y => `<option>${y}</option>`).join("");
    weekInput.innerHTML = Array.from({ length: 18 }, (_, i) =>
      `<option value="${i + 1}">${i + 1}</option>`
    ).join("");
  }

  async function loadStats() {
    const season = Number(document.getElementById("season-input").value);
    const week = Number(document.getElementById("week-input").value);
    const scoring = document.getElementById("scoring-filter").value;
    const positionFilter = document.getElementById("position-filter").value;
    const fantasyField = getFantasyField(scoring);

    document.getElementById("loading-indicator").classList.remove("hidden");

    const res = await fetch(
      `${BACKEND_URL}/nfl/player-usage/${season}/${week}?scoring=${encodeURIComponent(scoring)}`
    );
    const payload = await res.json();

    console.log("Sample row:", payload[0]);


    let rows = payload;

    if (positionFilter !== "ALL") {
      rows = rows.filter(r => {
        if (positionFilter === "WR/TE") {
          return r.position === "WR" || r.position === "TE";
        }
        return r.position === positionFilter;
      });
    }

    // Normalize fantasy points based on selected scoring
    rows = rows.map(r => ({
      ...r,
      fantasy_points_active: Number(r[fantasyField] ?? r.fantasy_points ?? 0)
    }));

    renderTopPerformers(currentRows);
    currentRows = rows;
    currentSort = { field: null, asc: true };

    document.getElementById("table-wrapper").classList.remove("hidden");
    renderRows(currentRows);
    enableSorting();

    document.getElementById("loading-indicator").classList.add("hidden");
  }

  document.addEventListener("DOMContentLoaded", () => {
    initDropdowns();
    document.getElementById("load-btn").addEventListener("click", loadStats);
    document.getElementById("position-filter") 
      .addEventListener("change", loadStats);
  });
</script>


  <script>
    document.getElementById("hamburger-toggle").addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("open");
    });

    // Sidebar dropdown
    document.querySelectorAll(".sidebar-dropdown .dropdown-toggle").forEach(btn => {
      btn.addEventListener("click", () => {
        const menu = btn.nextElementSibling;
        menu.style.display = menu.style.display === "flex" ? "none" : "flex";
      });
    });
  </script>
</body>
</html>
